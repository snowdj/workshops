<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2016-07-11 Mon 16:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>RCE Quick-Start</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Ista Zahn" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://tutorials.iq.harvard.edu/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://tutorials.iq.harvard.edu/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://tutorials.iq.harvard.edu/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">RCE Quick-Start</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">What is the RCE?</a></li>
<li><a href="#orgheadline2">Accessing the RCE</a></li>
<li><a href="#orgheadline3">Power at your fingertips</a></li>
<li><a href="#orgheadline4">Project folders &amp; shared space</a></li>
<li><a href="#orgheadline5">Getting your data on and off the RCE</a></li>
<li><a href="#orgheadline6">Interactive jobs</a>
<ul>
<li><a href="#orgheadline7">Launching applications on the interactive nodes</a></li>
<li><a href="#orgheadline8">Available RCE powered applications</a></li>
<li><a href="#orgheadline10">Using multiple CPUs in interactive jobs</a>
<ul>
<li><a href="#orgheadline13">Using multiple CPUs in interactive R programs</a></li>
<li><a href="#orgheadline14">Using multiple CUPs in Python</a></li>
<li><a href="#orgheadline15">Using multiple CPUs in other programming languages and applications</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline9">Batch Jobs Overview</a>
<ul>
<li><a href="#orgheadline16">Preparing for batch submission</a></li>
<li><a href="#orgheadline17">Submit file overview</a></li>
</ul>
</li>
<li><a href="#orgheadline22">Batch Job Examples</a>
<ul>
<li><a href="#orgheadline18">R Batch Examples</a>
<ul>
<li><a href="#orgheadline23">Batch example: Simple power simulation in R</a></li>
<li><a href="#orgheadline28">Batch example: Power simulation in R with varying parameters</a></li>
</ul>
</li>
<li><a href="#orgheadline19">Stata Batch Examples</a>
<ul>
<li><a href="#orgheadline33">Stata bootstrap do-file</a></li>
<li><a href="#orgheadline34">Submit file</a></li>
<li><a href="#orgheadline35">Aggregating results</a></li>
<li><a href="#orgheadline36">Try it yourself!</a></li>
</ul>
</li>
<li><a href="#orgheadline20">Python Batch Examples</a>
<ul>
<li><a href="#orgheadline37">Batch example: Simple power simulation in python</a></li>
<li><a href="#orgheadline42">Batch example: Power simulation in python with varying parameters</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline47">Monitoring and manageing submitted batch jobs</a>
<ul>
<li>
<ul>
<li><a href="#orgheadline21"><span class="todo TODO">TODO</span> Matlab Batch Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgheadline51"><span class="todo TODO">TODO</span> Installing custom packages on the RCE</a>
<ul>
<li><a href="#orgheadline48">Installing R packages</a></li>
<li><a href="#orgheadline49">Installing Python packages</a></li>
<li><a href="#orgheadline50">Installing Stata packages</a></li>
</ul>
</li>
<li><a href="#orgheadline52"><span class="todo TODO">TODO</span> Getting help</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1">What is the RCE?</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
The Research Computing Environment (RCE) is a large powerful computer cluster that you can use for computations that are too large to be conveniently done on a personal computer. The RCE is available to researchers at Harvard and MIT. 
</p>

<p>
To obtain an RCE account send an email to <a href="mailto:help@iq.harvard.edu">mailto:help@iq.harvard.edu</a>. You will receive a response asking you several questions about your requirements (e.g., if you need backups, how much data storage space you need). For details on the services provided and limitations and restrictions of the service refer to <a href="http://projects.iq.harvard.edu/user-services/research-computing-environment-sla">http://projects.iq.harvard.edu/user-services/research-computing-environment-sla</a>.
</p>

<p>
You can use the RCE in one of two primary ways:
</p>
<dl class="org-dl">
<dt>Interactive jobs</dt><dd>Run your computation as you would on your PC, but on a much more powerful machine with up to 24 CPU cores and up to 256Gb of memory.</dd>
<dt>Batch jobs</dt><dd>Run your computation in the background using up to several hundred computers at once.</dd>
</dl>

<p>
Interactive jobs are good for memory intensive computations that may be unfeasible on your personal computer due to hardware limitations. Batch jobs are good for computations that can be run in parallel and/or computations that you expect to run for long periods of time.
</p>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2">Accessing the RCE</h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
You can access the RCE using the <a href="http://projects.iq.harvard.edu/rce/nx4_installation">nomachine</a> remote desktop software, or via the command line using <code>ssh</code>. If you are a command line wizard and only need to run batch jobs <code>ssh</code> is the way to go; for most of us however <code>nomachine</code> is a much more useful way to access the RCE. It allows you to interact with the applications on the cluster much as you interact with applications on your local computer. 
</p>

<p>
To get started, download the NoMachine client for your operating system: 
</p>
<ul class="org-ul">
<li><a href="http://downloads.hmdc.harvard.edu/nx/4/nomachine-client-windows-latest.zip">Windows</a></li>
<li><a href="http://downloads.hmdc.harvard.edu/nx/4/nomachine-client-osx-latest.dmg">OSX</a></li>
<li><a href="http://downloads.hmdc.harvard.edu/nx/4/nomachine-client-linux-latest.zip">Linux</a></li>
</ul>

<p>
After downloading, Windows users should right-click on the <code>nomachine-client-windows-latest.zip</code> file and choose <code>Extract to here</code>. Open the <code>NoMachine Client</code> folder and double-click on the .Exe files to start the installation<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>. Mac users should double-click on the <code>nomachine-client-osx-latest.dmg</code> and double-click on the installer package to begin the installation.
</p>

<p>
Once you have installed the NoMachine software you should launch the NoMachine application and set up your login credentials. 
</p>

<p>
Once the application launches:
</p>
<ul class="org-ul">
<li>Click <code>Continue</code>.</li>
<li>Click <code>Click here to create a new connection</code>.</li>
<li>Keep clicking <code>Continue</code> until you get to the Hosts screen.</li>
<li>Fill in the Host field with <code>rce.hmdc.harvard.edu</code>.</li>
<li>Keep clicking <code>Continue</code> until you get to the Name screen.</li>
<li>Fill in the Name field with <code>RCE6</code> and click <code>Done</code>.</li>
</ul>

<p>
Once you have configured NoMachine you should test it out to make sure you can connect to the RCE: 
</p>
<ul class="org-ul">
<li>Click on the <code>RCE6</code> entry and then click <code>Connect</code>.</li>
<li>Fill in the user name and password fields with your RCE user name and password.</li>
<li>On the following screen click on <code>New virtual desktop or custom session</code>.</li>
<li>Click on <code>Create a new virtual desktop</code> and click <code>Continue</code>.</li>
</ul>

<p>
After completing these steps you should see an instruction screen; click <code>OK</code> and you should see your RCE desktop, which will look something like this:
</p>


<div class="figure">
<p><img src="images/rceDesktop.png" alt="rceDesktop.png" />
</p>
</div>

<p>
If you have any difficulties installing NoMachine, detailed documentation is available at <a href="http://projects.iq.harvard.edu/rce/nx4">http://projects.iq.harvard.edu/rce/nx4</a>; if you do not find a solution there send and email to <a href="mailto:help@iq.harvard.edu">help@iq.harvard.edu</a> and someone will assist you.
</p>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-2">
<h2 id="orgheadline3">Power at your fingertips</h2>
<div class="outline-text-2" id="text-orgheadline3">
<p>
You can run applications on the RCE <i>interactively</i> or using the <i>batch</i> system. If you simply want a more powerful version of your PC (e.g., more memory, more CPUs) then the interactive nodes are what you want. If you want to split your task up into hundreds of pieces and run each piece simultaneously, then you want the batch modes.
</p>

<p>
More specifically, the RCE provides three levels of service:
</p>
<dl class="org-dl">
<dt>Login nodes</dt><dd>Provides access to a desktop environment (similar to Remote Desktop) from which you can launch applications. The login nodes should not be used for computationally intensive jobs; the main function of the login nodes is to provide access to the interactive and batch nodes. You access the login nodes using the NoMachine client, as described in <a href="#orgheadline2">Accessing the RCE</a>.</dd>
<dt>Interactive nodes</dt><dd>Interactive nodes allow you to run applications on very powerful computers. You can launch applications on the interactive nodes from the login node desktop using the <code>Applications --&gt; RCE Powered Applications</code> menu. Applications launched from this menu will run on more powerful machines with large memory resources (up to 256GB) and up to 24 CPU cores.</dd>
<dt>Batch nodes</dt><dd>Where interactive nodes give you access to a single very powerful computer, batch nodes provide a swarm of hundreds of small computers. You can run your computation in parallel on each of them, which can provide dramatically reduced compute time for many applications. You access the batch nodes using the <i>command line</i> which you can access by starting a terminal application from the  <code>Applications --&gt; Accessories --&gt; terminal</code> menu.</dd>
</dl>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-2">
<h2 id="orgheadline4">Project folders &amp; shared space</h2>
<div class="outline-text-2" id="text-orgheadline4">
<p>
When your RCE account was created a home folder was set up for you, with <i>Documents</i>, <i>Downloads</i>, <i>Desktop</i> and other common sub-directories. However you can only store a maximum of 5Gb in your home folder. For larger projects you should use a <i>project folder</i>; one was probably set up for you when your account was activated. There is a shortcut in your home directory named <i>shared<sub>space</sub></i>, which will contain any project folders you have access to. You should store large data sets and other large or numerous files in these project folders.
</p>

<p>
Project space can be used privately, or shared with collaborators (hence the name, "shared space"). For more details on project folders refer to <a href="http://projects.iq.harvard.edu/rce/book/projects-and-shared-space">http://projects.iq.harvard.edu/rce/book/projects-and-shared-space</a> and <a href="http://projects.iq.harvard.edu/rce/book/project-space-collaboration">http://projects.iq.harvard.edu/rce/book/project-space-collaboration</a>.
</p>
</div>
</div>

<div id="outline-container-orgheadline5" class="outline-2">
<h2 id="orgheadline5">Getting your data on and off the RCE</h2>
<div class="outline-text-2" id="text-orgheadline5">
<p>
People often use the RCE for memory or CPU intensive data analysis projects. If this is your intention as well, chances are that you have one or more (potentially large) data files that you will need to copy to the RCE. Remember that disk space in your home directory is limited, so if you have a large amount of data make sure to <i>transfer data directly to your <a href="#orgheadline4">project space folder</a></i>.
</p>

<p>
The simplest approach is to use the NoMachine client to transfer data from your local machine to the RCE (and from the RCE to your local machine). Click on the red <code>!M</code> icon in the upper right-hand corner and select the <code>Send a file from the client</code> menu, as shown below.
</p>


<div class="figure">
<p><img src="images/NoMachineMenu.png" alt="NoMachineMenu.png" />
</p>
</div>

<p>
If you prefer to transfer files using another file transfer client, anything that uses ssh (e.g., <a href="http://filezilla-project.org/">FileZilla</a>) should work. Just point your favorite client to <code>rce.hmdc.harvard.edu</code>.
</p>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6">Interactive jobs</h2>
<div class="outline-text-2" id="text-orgheadline6">
<p>
When you first log on to the RCE you are on a <i>login node</i>. The login nodes are not designed for intensive computation; the purpose of the login nodes is to provide access to the <i>interactive nodes</i> and the <i>batch nodes</i>. Interactive jobs are useful when a) you need a lot of memory (e.g., because you need to load a large dataset into memory), and/or b) you want to use multiple cores to speed up your computation.
</p>
</div>

<div id="outline-container-orgheadline7" class="outline-3">
<h3 id="orgheadline7">Launching applications on the interactive nodes</h3>
<div class="outline-text-3" id="text-orgheadline7">
<p>
Running applications on the interactive nodes is very easy; just log in <a href="#orgheadline2">using NoMachine</a> and launch your application from the <code>Application --&gt; RCE Powered</code> menu. A dialog will open asking you how much memory you need and how many CPUs, and then your application will open. That's all there is to it! Well, we should say that the RCE is a shared resource, so please <i>try not to request more memory or CPUs than you need</i>. Also, applications running on the interactive nodes will expire after five days; you can request an extension, but if you fail to do so your job will be terminated 120 hours after it starts. For details refer to <a href="http://projects.iq.harvard.edu/rce/book/extending-rce-powered-application">http://projects.iq.harvard.edu/rce/book/extending-rce-powered-application</a>.
</p>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-3">
<h3 id="orgheadline8">Available RCE powered applications</h3>
<div class="outline-text-3" id="text-orgheadline8">
<p>
Available RCE powered applications include:
</p>
<ul class="org-ul">
<li>Gauss</li>
<li>Mathematica</li>
<li>Matlab/Octave</li>
<li>R/RStudio</li>
<li>SAS</li>
<li>Stata (MP and SE)</li>
<li>StatTransfer</li>
</ul>

<p>
Other applications (e.g., Python/IPython, perl, tesseract, various Unix programs and utilities) can be run on the interactive nodes by launching a terminal on an interactive node (<code>Applications --&gt; RCE Powered --&gt; RCE Shell</code>) and launching your program from the command line.
</p>

<p>
If you are using the interactive nodes primarily for the large memory they provide you should have all the information you need to begin taking advantage of the RCE. If you are also interested in using multiple CPU cores to speed up your computations, read on! The following sections contain examples illustrating techniques for utilizing multiple cores on the RCE.
</p>
</div>
</div>

<div id="outline-container-orgheadline10" class="outline-3">
<h3 id="orgheadline10">Using multiple CPUs in interactive jobs</h3>
<div class="outline-text-3" id="text-orgheadline10">
<p>
This section illustrates how to take advantage of multiple cores when running interactive jobs on the RCE, with the goal of getting CPU intensive tasks to run faster. <b>If you are not interested in running parallel processes in interactive jobs feel free to skip to the <a href="#orgheadline9">next section</a></b>.
</p>
</div>

<div id="outline-container-orgheadline13" class="outline-4">
<h4 id="orgheadline13">Using multiple CPUs in interactive R programs</h4>
<div class="outline-text-4" id="text-orgheadline13">
</div><ul class="org-ul"><li><a id="orgheadline11"></a>Using multiple cores to speed up simulations<br  /><div class="outline-text-5" id="text-orgheadline11">
<p>
Running computations in parallel on multiple cores is often an effective way to speed up computations. This can be especially useful when doing simulations, or when using resampling methods such as bootstrap or permutation tests. In this example parallel processing is used to simulate the sampling distribution of the mean for samples of various sizes.
</p>

<p>
We start by setting up a helper function to repeatedly generate a sample of a given size and calculate the sample mean.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to generate distribution of means for a range of sample sizes</span>
<span style="color: #bc6ec5; font-weight: bold;">meanDist</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(n, nsamp = <span style="color: #a45bad;">5000</span>) {
  replicate(nsamp, mean(rnorm(n)))
}

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">range of sample sizes to iterate over</span>
sampSizes <span style="color: #a45bad;">&lt;-</span> seq(<span style="color: #a45bad;">10</span>, <span style="color: #a45bad;">500</span>, by = <span style="color: #a45bad;">5</span>)
</pre>
</div>

<p>
Next iterate over a range of sample sizes, generating a distribution of means for each one. This can be slow because R normally uses only one core:
</p>
<div class="org-src-container">

<pre class="src src-R">system.time(means <span style="color: #a45bad;">&lt;-</span> lapply(sampSizes, meanDist))
</pre>
</div>

<pre class="example">
  user  system elapsed 
42.220   0.027  42.254
</pre>

<p>
The simulation can be carried out much more rapidly using <code>mclapply</code> instead:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #a45bad;">library</span>(parallel) 
system.time(means <span style="color: #a45bad;">&lt;-</span> mclapply(sampSizes, meanDist, mc.cores = <span style="color: #a45bad;">7</span>))
</pre>
</div>

<pre class="example">
  user  system elapsed 
43.300   2.254   6.862
</pre>

<p>
Like <code>lapply</code> the <code>mclapply</code> function returns a list, which we can process as usual. For example, we can construct histograms of the sampling distributions of the mean that we simulated above:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">plot the distribution of means at various sample sizes</span>
par(mfrow=c(<span style="color: #a45bad;">6</span>, <span style="color: #a45bad;">5</span>), mar = c(<span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">0</span>,<span style="color: #a45bad;">2</span>,<span style="color: #a45bad;">2</span>), cex = .7)
<span style="color: #4f97d7; font-weight: bold;">for</span>(i <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #a45bad;">1</span>:<span style="color: #a45bad;">30</span>) {
  hist(means[[i]], 
       main = paste(<span style="color: #2d9574;">"n ="</span>, 
                    sampSizes[i]), 
       axes = <span style="color: #ce537a; font-weight: bold;">FALSE</span>,
       xlim = range(unlist(means)))
}
</pre>
</div>


<div class="figure">
<p><img src="images/samplingDist.png" alt="samplingDist.png" />
</p>
</div>
</div></li>


<li><a id="orgheadline12"></a>Using multiple cores to speed up computations<br  /><div class="outline-text-5" id="text-orgheadline12">
<p>
In the previous example we generated the data on each iteration. This kind of simulation can be useful, but often you want to parallelize a function that processes data from a (potentially large) number of files. This is also easy to do using the parallel package in R. In the following example we count number of characters in all the text files in the texlive directory.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">List the files to iterate over</span>
textFiles<span style="color: #a45bad;">&lt;-</span> list.files(<span style="color: #2d9574;">"/usr/share/texlive/"</span>, 
                       recursive = <span style="color: #ce537a; font-weight: bold;">TRUE</span>, 
                       pattern = <span style="color: #2d9574;">"\\.txt$|\\.tex$"</span>,
                       full.names = <span style="color: #ce537a; font-weight: bold;">TRUE</span>)

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function for counting characters (</span><span style="color: #d0bf8f;">NOTE</span><span style="color: #2aa1ae; background-color: #292e34;">: this example isn't realistic -- it </span>
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">would be better to use the unix "wc" utility if you were doing this</span>
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">in real life...)</span>
<span style="color: #bc6ec5; font-weight: bold;">countChars</span> <span style="color: #a45bad;">&lt;-</span>  <span style="color: #4f97d7; font-weight: bold;">function</span>(x) {
  sum(nchar(readLines(x, warn = <span style="color: #ce537a; font-weight: bold;">FALSE</span>), type = <span style="color: #2d9574;">"width"</span>))
}
</pre>
</div>

<p>
We have <code class="src src-r">length(textFiles)
</code> text files to process. We can do this using a single core:
</p>
<div class="org-src-container">

<pre class="src src-R">system.time(nchars <span style="color: #a45bad;">&lt;-</span> unlist(lapply(textFiles, countChars)))
</pre>
</div>

<pre class="example">
  user  system elapsed 
29.023   0.226  32.107
</pre>

<p>
but this is too slow. We can do the computation more quickly using multiple cores:
</p>
<div class="org-src-container">

<pre class="src src-R">system.time(nchars <span style="color: #a45bad;">&lt;-</span> unlist(mclapply(textFiles, countChars, mc.cores = <span style="color: #a45bad;">7</span>)))
</pre>
</div>

<pre class="example">
  user  system elapsed 
23.141   0.537   5.200
</pre>
<p>
and calculate the total number of characters in the text files by summing over the result
</p>
<div class="org-src-container">

<pre class="src src-R">sum(nchars, na.rm = <span style="color: #ce537a; font-weight: bold;">TRUE</span>)
</pre>
</div>

<pre class="example">
[1] 31617376
</pre>

<p>
For more details and examples using the parallel package, refer to the <a href="https://stat.ethz.ch/R-manual/R-devel/library/parallel/doc/parallel.pdf">parallel package documentation</a> or run <code>help(package = "parallel")</code> at the R prompt. For other ways of running computations in parallel refer to the <a href="http://cran.r-project.org/web/views/HighPerformanceComputing.html">HPC task view</a>.
</p>
</div></li></ul>
</div>

<div id="outline-container-orgheadline14" class="outline-4">
<h4 id="orgheadline14">Using multiple CUPs in Python</h4>
<div class="outline-text-4" id="text-orgheadline14">
<p>
Running computations in parallel on multiple cores is often an effective way to speed up computations. This can be useful when we want to iterate over a set of inputs, e.g., applying a function to each of a set of files. In this example we count the number of characters in all the files under the texlive directory. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> os
<span style="color: #4f97d7; font-weight: bold;">import</span> fnmatch
<span style="color: #7590db;">textFiles</span> = []
<span style="color: #4f97d7; font-weight: bold;">for</span> root, dirnames, filenames <span style="color: #4f97d7; font-weight: bold;">in</span> os.walk(<span style="color: #2d9574;">'/usr/share/texlive'</span>):
    <span style="color: #4f97d7; font-weight: bold;">for</span> filename <span style="color: #4f97d7; font-weight: bold;">in</span> fnmatch.<span style="color: #4f97d7;">filter</span>(filenames, <span style="color: #2d9574;">'*.tex'</span>) + fnmatch.<span style="color: #4f97d7;">filter</span>(filenames, <span style="color: #2d9574;">"*.txt"</span>):
        textFiles.append(os.path.join(root, filename))
</pre>
</div>

<p>
We have <code class="src src-python"><span style="color: #4f97d7;">len</span>(textFiles)
</code> <code>2080</code> text files to process. We can do this using a single core:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> time
<span style="color: #7590db;">start</span> = time.time()

<span style="color: #7590db;">num_chars</span> = <span style="color: #a45bad;">0</span>
<span style="color: #4f97d7; font-weight: bold;">for</span> fname <span style="color: #4f97d7; font-weight: bold;">in</span> textFiles:
    <span style="color: #4f97d7; font-weight: bold;">try</span>:
        <span style="color: #4f97d7; font-weight: bold;">with</span> <span style="color: #4f97d7;">open</span>(fname, <span style="color: #2d9574;">'r'</span>) <span style="color: #4f97d7; font-weight: bold;">as</span> f:
            <span style="color: #4f97d7; font-weight: bold;">for</span> line <span style="color: #4f97d7; font-weight: bold;">in</span> f:
                <span style="color: #7590db;">num_chars</span> += <span style="color: #4f97d7;">len</span>(line)
    <span style="color: #4f97d7; font-weight: bold;">except</span>:
        <span style="color: #4f97d7; font-weight: bold;">pass</span>

<span style="color: #7590db;">stop</span> = time.time()
</pre>
</div>
<p>
. It takes around <code class="src src-python"><span style="color: #4f97d7; font-weight: bold;">print</span>(stop - start)
</code> <code>1.2721843719482422</code> seconds to count the characters in these files, which is aleady pretty fast. But, for even more speed we can use the <code>multiprocessing</code> library to perform the operation using multiple cores:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> multiprocessing

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">f</span>(fname):
    <span style="color: #7590db;">num_chars</span> = []
    <span style="color: #4f97d7; font-weight: bold;">try</span>:
        <span style="color: #4f97d7; font-weight: bold;">with</span> <span style="color: #4f97d7;">open</span>(fname, <span style="color: #2d9574;">'r'</span>) <span style="color: #4f97d7; font-weight: bold;">as</span> this_file:
            <span style="color: #4f97d7; font-weight: bold;">for</span> line <span style="color: #4f97d7; font-weight: bold;">in</span> this_file:
                num_chars.append(<span style="color: #4f97d7;">len</span>(line))
    <span style="color: #4f97d7; font-weight: bold;">except</span>:
        <span style="color: #4f97d7; font-weight: bold;">pass</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> <span style="color: #4f97d7;">sum</span>(num_chars)

<span style="color: #7590db;">start</span> = time.time()

<span style="color: #7590db;">pool</span> = multiprocessing.Pool(<span style="color: #a45bad;">7</span>)
<span style="color: #7590db;">nchar</span> = pool.<span style="color: #4f97d7;">map</span>(f, textFiles)
pool.close()
pool.join()

<span style="color: #7590db;">end</span> = time.time()
</pre>
</div>
<p>
which reduces the time to <code class="src src-python"><span style="color: #4f97d7; font-weight: bold;">print</span>(end - start)
</code> <code>0.33490753173828125</code> seconds.
</p>
</div>
</div>




<div id="outline-container-orgheadline15" class="outline-4">
<h4 id="orgheadline15">Using multiple CPUs in other programming languages and applications</h4>
<div class="outline-text-4" id="text-orgheadline15">
<p>
Using multiple CPU cores in Stata, Matlab and SAS does not require explicit activation &#x2013; many functions will automatically use multiple cores if available. For Matlab user-written code can also take advantage of multiple CPUs using the <code>parfor</code> command. Python uses can run multiple processes using the <a href="https://docs.python.org/2/library/multiprocessing.html">multiprocessing</a> library.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9">Batch Jobs Overview</h2>
<div class="outline-text-2" id="text-orgheadline9">
<p>
The RCE provides access to <i>batch nodes</i>, a cluster of many computers. The batch nodes are good for jobs will run for a long time, and for groups of very similar jobs (e.g., simulations where a number of parameters are varied).
</p>

<p>
Running jobs on the batch nodes is somewhat more complicated than running <a href="#orgheadline6">interactive jobs</a> on the RCE. The main access points are two <i>command line</i> programs, <code>condor_submit_util</code> and <code>condor_submit</code>. In this tutorial we focus on writing simple submit files and submitting them with <code>condor_submit</code>. For more details on automatically generating and submitting using <code>condor_submit_util</code> refer to the main <a href="http://projects.iq.harvard.edu/rce/book/batch-processing-basics">RCE batch job documentation</a>. 
</p>
</div>

<div id="outline-container-orgheadline16" class="outline-3">
<h3 id="orgheadline16">Preparing for batch submission</h3>
<div class="outline-text-3" id="text-orgheadline16">
<p>
In practical terms, running in "batch" means that you will not be able to interact with the running process. This means that all the information your program needs to successfully complete needs to be specified ahead of time. You can pass arguments to your process so that each job gets different inputs, but the script must process these arguments and do the right thing without further instruction.
</p>

<p>
When you submit a job to the batch processing system each process will generate output and (perhaps) errors. It is usually a good idea to make a sub-folder to store these results. Thus your project folder should contain at least the following:
</p>
<ul class="org-ul">
<li>script or program to run</li>
<li>submit file</li>
<li>output directory</li>
</ul>

<p>
When preparing your job for batch submission you usually need to figure out how to split up the computation, (with one piece going to each process), and how to tell each process which piece it is responsible for. The examples below illustrate how to do this.
</p>
</div>
</div>

<div id="outline-container-orgheadline17" class="outline-3">
<h3 id="orgheadline17">Submit file overview</h3>
<div class="outline-text-3" id="text-orgheadline17">
<p>
In order to run jobs in parallel on the batch nodes you need to create a <code>submit file</code> that describes the process to be run on each node. If creating these files by hand you may use any text editor (e.g., <code>gedit</code>, accessible though the <code>Applications --&gt; Accessories</code> menu on the RCE). 
</p>

<p>
The submit file template below includes all required elements. (Note that this file is a template only &#x2013; see the next section for working examples.)
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
<span style="color: #7590db;">Universe</span> = vanilla

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">The following arguments are _optional_. If included</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">they are used to specify the requirements for the</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">submission.</span>
<span style="color: #7590db;">request_cpus</span> = 1
<span style="color: #7590db;">request_disk</span> = 4GB
<span style="color: #7590db;">request_memory</span> = 4GB

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the program you wish to run.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">The default runs the R program. To run another</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">program just change '/user/local/bin/R' to the</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">path to the program you want to run. For example,</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">to run Stata set Executable to '/usr/local/bin/stata'.</span>
<span style="color: #7590db;">Executable</span> = /usr/local/bin/R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable.</span>
<span style="color: #7590db;">Arguments</span> = --no-save --no-restore --slave

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify the relative path to the input file (if any). If you</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">are using R this should be your R script. If you are using</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Stata this should be your do file.</span>
<span style="color: #7590db;">input</span> = example.R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to output any results printed by your program.</span>
<span style="color: #7590db;">output</span> = output/out.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
<span style="color: #7590db;">error</span> = output/error.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save the log file.</span>
<span style="color: #7590db;">Log</span> = output/log
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request. This should </span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">always be the last part of your submit file.</span>
Queue 10
</pre>
</div>
<p>
This submit file instructs the scheduler to request 10 nodes (<code>Queue 10</code>), start R<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup> on each one (<code>Executable = /usr/local/bin/R</code>), run the code in example.R (<code>input = example.R</code>), write the output to files named out.0 &#x2013; out.9 in the output folder (<code>output = output/out.$(Process)</code>), write any errors to files named out.0 &#x2013; out.9 in the output folder (<code>error = output/error.$(Process)</code>), and write a log file in the output folder (<code>Log = output/log</code>). Each of the 10 requested nodes must be able to provide at least one cpu (<code>request_cpus = 1</code>), four Gb of disk space (<code>request_disk = 4GB</code>) and four Gb of memory (<code>request_memory = 4GB</code>).
</p>

<p>
The elements included in the submit file template above should be suffucient for most jobs. You can <a href="template.submit">download this submit file template</a> and modify it to suit your needs. For a complete description of the Condor submit file syntax, including less commonly used elements not described here refer to the <a href="http://research.cs.wisc.edu/htcondor/manual/current/condor_submit.html">official documentation</a>. 
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline22" class="outline-2">
<h2 id="orgheadline22">Batch Job Examples</h2>
<div class="outline-text-2" id="text-orgheadline22">
<p>
RCE users come from a variety of backgrounds and different people are more proficient with different software packages. Feel free to skip to the batch examples using the software you are most comfortable with:
</p>
<ul class="org-ul">
<li><a href="#orgheadline18">R Batch Examples</a></li>
<li><a href="#orgheadline19">Stata Batch Examples</a></li>
<li><a href="#orgheadline20">Python Batch Examples</a></li>
<li><a href="#orgheadline21">Matlab Batch Examples</a></li>
</ul>
</div>

<div id="outline-container-orgheadline18" class="outline-3">
<h3 id="orgheadline18">R Batch Examples</h3>
<div class="outline-text-3" id="text-orgheadline18">
</div><div id="outline-container-orgheadline23" class="outline-4">
<h4 id="orgheadline23">Batch example: Simple power simulation in R</h4>
<div class="outline-text-4" id="text-orgheadline23">
<p>
The simplest kind of batch job is one for which you just want to run the same code multiple times, without varying any parameters. For example, suppose that we wish to run a power simulation for a t.test with unequal group sizes. 
</p>
</div>

<ul class="org-ul"><li><a id="orgheadline24"></a>R power simulation script<br  /><div class="outline-text-5" id="text-orgheadline24">
<p>
The first step is to write a script or program to carry out the desired computation. The R script below simulates distributions with a specified mean difference, performs two-sample t-tests on the difference, and calculates the proportion of significant tests.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to simulate data and perform a t.test</span>
<span style="color: #bc6ec5; font-weight: bold;">sim.ttest</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(mu1, mu2, sd, n1, n2) {
    d <span style="color: #a45bad;">&lt;-</span> data.frame(x = c(rep(<span style="color: #2d9574;">"group1"</span>, n1), rep(<span style="color: #2d9574;">"group2"</span>, n2)),
                    y = c(rnorm(n1, mean = mu1, sd = sd),
                          rnorm(n2, mean = mu2, sd = sd)))
    <span style="color: #4f97d7; font-weight: bold;">return</span>(t.test(y ~ x, data = d)$p.value)
}

<span style="color: #2aa1ae; background-color: #292e34;">##  </span><span style="color: #2aa1ae; background-color: #292e34;">run the function 10,000 times </span>
p <span style="color: #a45bad;">&lt;-</span> replicate(<span style="color: #a45bad;">10000</span>,
               sim.ttest(mu1 = <span style="color: #a45bad;">1</span>,
                         mu2 = <span style="color: #a45bad;">1.3</span>,
                         sd = <span style="color: #a45bad;">1</span>,
                         n1 = <span style="color: #a45bad;">50</span>,
                         n2 = <span style="color: #a45bad;">150</span>))
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">calculate the proportion of significant tests</span>
cat(length(p[p &lt; .05])/length(p))
</pre>
</div>
</div></li>

<li><a id="orgheadline25"></a>Submit file<br  /><div class="outline-text-5" id="text-orgheadline25">
<p>
If we want to run this function one million times it may take a while, especially if our computer is an older less powerful model. So let's run it on 100 separate machines (each one will simulate the test 10000 times). To do that we need, in addition to the R script above, a submit file to request resources and run the computation.  
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
<span style="color: #7590db;">Universe</span> = vanilla

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the R program.</span>
<span style="color: #7590db;">Executable</span> = /usr/local/bin/R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Here we pass arguments to make R not save or restore workspaces,</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">and to run as quietly as possible.</span>
<span style="color: #7590db;">Arguments</span> = --no-save --no-restore --slave

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify the relative path to the input file</span>
<span style="color: #7590db;">input</span> = power.R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to output any results printed by your program.</span>
<span style="color: #7590db;">output</span> = output/out.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
<span style="color: #7590db;">error</span> = output/error.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save the log file.</span>
<span style="color: #7590db;">Log</span> = output/log

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">This section should always come last.</span>
Queue 100
</pre>
</div>

<p>
Now that we have our script and the submit file we can run submit the job as follows:
</p>
<ol class="org-ol">
<li>make a project folder for this run if it doesn't exist</li>
<li>save the R script (as power.R) and the submit file (as power.submit) in the project folder</li>
<li>make a sub folder named <code>output</code></li>
<li>open a terminal and <code>cd</code> to the project folder</li>
<li>run <code>condor_submit power.submit</code> to submit the jobs to the cluster</li>
</ol>
</div></li>

<li><a id="orgheadline26"></a>Aggregating results<br  /><div class="outline-text-5" id="text-orgheadline26">
<p>
When your batch job is finished you are usually left with multiple output files that need to be aggregated. In the case of our simulation example, we have files <code>output/out.0 -- output/out99</code>, each of which contains a single number representing the proportion of significant tests. We can aggregate them with a simple R script, like this:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">list all output files in the output directory</span>
output_files <span style="color: #a45bad;">&lt;-</span> list.files(<span style="color: #2d9574;">"output"</span>,
                           pattern = <span style="color: #2d9574;">"^out\\.[0-9]+$"</span>,
                           full.names=<span style="color: #ce537a; font-weight: bold;">TRUE</span>)

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">read each file, convert it to a number, and take the average</span>
mean(as.double(sapply(
                      output_files,
                      readLines,
                      warn = <span style="color: #ce537a; font-weight: bold;">FALSE</span>)))
</pre>
</div>
</div></li>

<li><a id="orgheadline27"></a>Try it yourself!<br  /><div class="outline-text-5" id="text-orgheadline27">
<p>
Download the <a href="R_examples/power1.zip">power simulation example files</a>, to the RCE, extract the zip file and running <code>condor_submit power.submit</code> in the <code>power1</code> directory.
</p>
</div></li></ul>
</div>

<div id="outline-container-orgheadline28" class="outline-4">
<h4 id="orgheadline28">Batch example: Power simulation in R with varying parameters</h4>
<div class="outline-text-4" id="text-orgheadline28">
<p>
The previous example was relatively simple, because we wanted to run exactly the same code on all 100 nodes. Often however you want each node to do something slightly different. For example, we may wish to vary the sample size from 100 &#x2013; 500 in increments of 10, to see how power changes as a function of that parameter. In that case we need to pass some additional information to each process, telling it which parameter space it is responsible for. 
</p>

<p>
As it turns out, we almost already know how to do that: if you you look closely at the submit file in the previous example you will notice that we used <code>$(Process)</code> to append the process number to the output and error files. 
</p>
</div>
<ul class="org-ul"><li><a id="orgheadline29"></a>Submit file passing process as an argument<br  /><div class="outline-text-5" id="text-orgheadline29">
<p>
We can use the <code>$(Process)</code> macro to pass information to our program, like this:
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
<span style="color: #7590db;">Universe</span> = vanilla

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the R program.</span>
<span style="color: #7590db;">Executable</span> = /usr/local/bin/R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">to make r not save or restore workspaces, and to </span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">run as quietly as possible</span>
<span style="color: #7590db;">Arguments</span> = --no-save --no-restore --slave --args $(Process)

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify the relative path to the input file</span>
<span style="color: #7590db;">input</span> = power.R

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
<span style="color: #7590db;">error</span> = output/error.$(Process)

<span style="color: #7590db;">Log</span> = log.txt
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request.</span>
Queue 40
</pre>
</div>
<p>
Notice that we used <code>--args $(Process)</code> to pass the process number to the R program. <code>$(Process)</code> will be an integer starting from <code>0</code>. 
</p>
</div></li>

<li><a id="orgheadline30"></a>R script argument processing<br  /><div class="outline-text-5" id="text-orgheadline30">
<p>
Next we need to 1) retrieve the process number in our R program and 2) map it to the parameter space. We can retrieve the arguments in R like this:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">retrieve arguments passed from the command line.</span>
process <span style="color: #a45bad;">&lt;-</span> as.integer(as.character(commandArgs(trailingOnly = <span style="color: #ce537a; font-weight: bold;">TRUE</span>)))
</pre>
</div>
<p>
We now have a variable in R that tells us which process we are. Now we need to map that to our parameter space; recall that we want to test sample sizes from 100 to 500, so we need to map <code>process 0</code> to <code>n = 100</code>,  <code>process 1</code> to <code>n = 110</code>, <code>process 2</code> to <code>n = 120</code> and so on:
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">map process to sample size parameter.</span>
n <span style="color: #a45bad;">&lt;-</span> (process + <span style="color: #a45bad;">100</span>) + (process*<span style="color: #a45bad;">10</span> - process)
</pre>
</div>

<p>
There is one additional complication we need to handle: in the previous example we did need to keep track of the parameters used by each process because the parameters did not vary. Now that they do, it would be nice if we had output that recorded the value of the varying parameter as well as the result. We could of course just print the <code>n</code> parameter we calculated from the process number along with the result, but it will be easier to combine the outputs if we write them to a machine-readable format (e.g., a comma-separated-values file). You may have noticed that in the submit file above I omitted the <code>output</code> directive: that is because we are going to explicitly save the results in the R script, so we don't need the batch scheduler to save those output files for us.
</p>

<p>
Now we can set up the simulation as before, passing the <code>n</code> calculated above into our simulation function, writing the results to files. 
</p>
<div class="org-src-container">

<pre class="src src-R">  <span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to simulate data and perform a t.test</span>
  <span style="color: #bc6ec5; font-weight: bold;">sim.ttest</span> <span style="color: #a45bad;">&lt;-</span> <span style="color: #4f97d7; font-weight: bold;">function</span>(mu1, mu2, sd, n1, n2) {
      d <span style="color: #a45bad;">&lt;-</span> data.frame(x = c(rep(<span style="color: #2d9574;">"group1"</span>, n1), rep(<span style="color: #2d9574;">"group2"</span>, n2)),
                      y = c(rnorm(n1, mean = mu1, sd = sd),
                            rnorm(n2, mean = mu2, sd = sd)))
      <span style="color: #4f97d7; font-weight: bold;">return</span>(t.test(y ~ x, data = d)$p.value)
  }

  <span style="color: #2aa1ae; background-color: #292e34;">##  </span><span style="color: #2aa1ae; background-color: #292e34;">run the function 10,000 times </span>
  p <span style="color: #a45bad;">&lt;-</span> replicate(<span style="color: #a45bad;">10000</span>,
                 sim.ttest(mu1 = <span style="color: #a45bad;">1</span>,
                           mu2 = <span style="color: #a45bad;">1.3</span>,
                           sd = <span style="color: #a45bad;">1</span>,
                           n1 = n,
                           n2 = n))
write.csv(data.frame(n = n, power = length(p[p &lt; .05])/length(p)),
          row.names = <span style="color: #ce537a; font-weight: bold;">FALSE</span>,
          file = paste0(<span style="color: #2d9574;">"output/out"</span>, process, <span style="color: #2d9574;">".csv"</span>))
</pre>
</div>

<p>
Now we have all the required elements to submit out job, and can do so using <code>condor_submit</code> as before. 
</p>
</div></li>

<li><a id="orgheadline31"></a>Aggregating results<br  /><div class="outline-text-5" id="text-orgheadline31">
<p>
Each of our 40 processes produced a file in the <code>output</code> directory name <code>out&lt;process&gt;csv</code>; our next task is to aggregate these results. The R script below reads each of these files, joins them together into a single data.frame, and plots the result.
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">list all output files in the output directory</span>
output_files <span style="color: #a45bad;">&lt;-</span> list.files(<span style="color: #2d9574;">"output"</span>,
                           pattern = <span style="color: #2d9574;">"^out[0-9]+\\.csv$"</span>,
                           full.names=<span style="color: #ce537a; font-weight: bold;">TRUE</span>)

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">read each file and append them</span>
results <span style="color: #a45bad;">&lt;-</span> do.call(rbind, lapply(output_files, read.csv))

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">plot</span>
plot(results)
abline(h = <span style="color: #a45bad;">0.8</span>)
</pre>
</div>


<div class="figure">
<p><img src="images/powerDist.png" alt="powerDist.png" />
</p>
</div>
</div></li>

<li><a id="orgheadline32"></a>Try it yourself!<br  /><div class="outline-text-5" id="text-orgheadline32">
<p>
Download the <a href="R_examples/power2.zip">power simulation example files</a>, to the RCE, extract the zip file, and run the example by calling <code>condor_submit power.submit</code> from the <code>power2</code> directory.
</p>
</div></li></ul>
</div>
</div>

<div id="outline-container-orgheadline19" class="outline-3">
<h3 id="orgheadline19">Stata Batch Examples</h3>
<div class="outline-text-3" id="text-orgheadline19">
<p>
In this example we use the batch system to bootstrap a distribution of means. Each process will calculate the mean for a single bootstrap sample and save the result. Since we need to give the output files unique names we will pass the batch process number to Stata and use it to construct the file names.
</p>
</div>
<div id="outline-container-orgheadline33" class="outline-4">
<h4 id="orgheadline33">Stata bootstrap do-file</h4>
<div class="outline-text-4" id="text-orgheadline33">
<p>
To use the batch system we need to write a do-file that does the calculation without further user input. The do-file below reads a Stata data set, sets a seed for random number generation, samples (with replacement) from the data, calculates the average value of the sampled data, and saves the result.
</p>
<div class="org-src-container">

<pre class="src src-stata"><span style="color: #a45bad;">set</span> <span style="color: #a45bad;">mo</span><span style="color: #ce537a; font-weight: bold;">re</span> off

<span style="color: #2aa1ae; background-color: #292e34;">// collect the arguments passed by submit file</span>
args process

<span style="color: #2aa1ae; background-color: #292e34;">// load the dataset</span>
<span style="color: #4f97d7; font-weight: bold;">use</span> <span style="color: #2d9574;">"mydata"</span>, <span style="color: #4f97d7; font-weight: bold;">clear</span>

<span style="color: #2aa1ae; background-color: #292e34;">// set seed (shouldn't have to do this, but stata's</span>
<span style="color: #2aa1ae; background-color: #292e34;">// random bsample defaults to the same seed each time).</span>
<span style="color: #2aa1ae; background-color: #292e34;">// we nee to find a better way to do this.</span>
<span style="color: #a45bad;">set</span> <span style="color: #a45bad;">se</span><span style="color: #ce537a; font-weight: bold;">ed</span> `<span style="color: #7590db;">process</span>'

<span style="color: #2aa1ae; background-color: #292e34;">// sample with replacement</span>
<span style="color: #4f97d7; font-weight: bold;">bsample</span>, cluster(id) idcluster(newid)

<span style="color: #2aa1ae; background-color: #292e34;">// calculate the mean and standard deviation</span>
collapse (mean) mean_myvar = myvar (sd) sd_myvar = myvar

<span style="color: #2aa1ae; background-color: #292e34;">// save the result, appending the process number to the file name</span>
<span style="color: #4f97d7; font-weight: bold;">save</span> <span style="color: #2d9574;">"output/output_`</span><span style="color: #7590db;">process</span><span style="color: #2d9574;">'.dta"</span>, <span style="color: #4f97d7; font-weight: bold;">replace</span>
</pre>
</div>
<p>
Note the use of <code>args process</code>, which retrieves the value of the process argument. The argument itself is specified in the <code>.submit</code> file (see below).
</p>
</div>
</div>
<div id="outline-container-orgheadline34" class="outline-4">
<h4 id="orgheadline34">Submit file</h4>
<div class="outline-text-4" id="text-orgheadline34">
<p>
The Stata code in the example above draws one bootstrap sample and calculates the mean. If we want to do this 1,000 times we could write a loop, but each iteration would be done sequentially. We can carry out this operation faster by running it simultaneously on hundreds of machines. We just need a <code>.submit</code> file like the one below:
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
<span style="color: #7590db;">Universe</span> = vanilla

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the Stata program.</span>
<span style="color: #7590db;">Executable</span> = /usr/local/bin/stata-mp

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Here we pass arguments to make Stata run the bootstrap.do</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">file. We also pass the process number, which will be used</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">to append the process number to the output files.</span>
<span style="color: #7590db;">Arguments</span> = -q do bootstrap.do $(Process)

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to output any results printed by your program.</span>
<span style="color: #7590db;">output</span> = output/bootstrap$(Process).out
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
<span style="color: #7590db;">error</span> = output/bootstrap$(Process).err
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save the log file.</span>
<span style="color: #7590db;">Log</span> = output/bootstrap$(Process).log

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">This section should always come last.</span>
Queue 1000
</pre>
</div>
<p>
Notice that we passed the <code>$(Process)</code> argument so that we can retrieve that value in the do-file and save each output to a unique file that includes the process name.
</p>

<p>
To submit this job we open a terminal on the RCE, <code>cd</code> to the project folder and run <code>condor_submit bootstrap.submit</code> to submit the jobs to the cluster. The <a href="Stata_examples/bootstrap.zip">bootstrap example files are available for download</a> so you can try it yourself.
</p>
</div>
</div>

<div id="outline-container-orgheadline35" class="outline-4">
<h4 id="orgheadline35">Aggregating results</h4>
<div class="outline-text-4" id="text-orgheadline35">
<p>
Each of our 1000 processes produced a file in the <code>output</code> directory name <code>out&lt;process&gt;.dta</code>; our next task is to aggregate these results. The do-file below reads each of these files, joins them together, appends them, and plots the result.
</p>
<div class="org-src-container">

<pre class="src src-Stata"><span style="color: #4f97d7; font-weight: bold;">clear</span>
<span style="color: #a45bad;">set</span> <span style="color: #a45bad;">mo</span><span style="color: #ce537a; font-weight: bold;">re</span> off
<span style="color: #2aa1ae; background-color: #292e34;">// change to the output directory</span>
<span style="color: #4f97d7; font-weight: bold;">cd</span> output
<span style="color: #2aa1ae; background-color: #292e34;">// get a list of the output files created by bootstrap.do</span>
<span style="color: #a45bad;">local</span><span style="color: #7590db;"> list</span>: <span style="color: #a45bad;">dir</span> . files <span style="color: #2d9574;">"output*.dta"</span>
<span style="color: #2aa1ae; background-color: #292e34;">//loop over the output files appending each one</span>
<span style="color: #a45bad;">local</span><span style="color: #7590db;"> f</span>=<span style="color: #a45bad;">1</span>
foreach file of local <span style="color: #a45bad;">list</span> {
        <span style="color: #a45bad;">di</span> <span style="color: #2d9574;">"`file"</span>'
        <span style="color: #a45bad;">if</span> `<span style="color: #7590db;">f</span>'== <span style="color: #a45bad;">1</span> {
                <span style="color: #4f97d7; font-weight: bold;">use</span> `<span style="color: #7590db;">file</span>', <span style="color: #4f97d7; font-weight: bold;">clear</span>
        }
        <span style="color: #a45bad;">else</span> {
                <span style="color: #4f97d7; font-weight: bold;">append</span> <span style="color: #a45bad;">using</span> `<span style="color: #7590db;">file</span>'
        }
        <span style="color: #a45bad;">local</span> ++f
}
<span style="color: #2aa1ae; background-color: #292e34;">// save the appended results</span>
saveold <span style="color: #2d9574;">"mybootresults"</span>, <span style="color: #4f97d7; font-weight: bold;">replace</span>

<span style="color: #2aa1ae; background-color: #292e34;">// make a histogram</span>
hist(mean_myvar)

<span style="color: #2aa1ae; background-color: #292e34;">// save the graph</span>
graph export <span style="color: #2d9574;">"stata_bootstrap.eps"</span>, <span style="color: #4f97d7; font-weight: bold;">replace</span>
</pre>
</div>


<div class="figure">
<p><img src="images/stata_bootstrap.png" alt="stata_bootstrap.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-orgheadline36" class="outline-4">
<h4 id="orgheadline36">Try it yourself!</h4>
<div class="outline-text-4" id="text-orgheadline36">
<p>
Download the <a href="Stata_examples/bootstrap.zip">bootstrap example files</a>, to the RCE, extract the zip file, and run the example by calling <code>condor_submit bootstrap.submit</code> from the <code>bootstrap</code> directory.
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline20" class="outline-3">
<h3 id="orgheadline20">Python Batch Examples</h3>
<div class="outline-text-3" id="text-orgheadline20">
</div><div id="outline-container-orgheadline37" class="outline-4">
<h4 id="orgheadline37">Batch example: Simple power simulation in python</h4>
<div class="outline-text-4" id="text-orgheadline37">
<p>
The simplest kind of batch job is one for which you just want to run the same code multiple times, without varying any parameters. For example, suppose that we wish to run a power simulation for a t.test with unequal group sizes. 
</p>
</div>

<ul class="org-ul"><li><a id="orgheadline38"></a>python power simulation script<br  /><div class="outline-text-5" id="text-orgheadline38">
<p>
The first step is to write a script or program to carry out the desired computation. The python script below simulates distributions with a specified mean difference, performs two-sample t-tests on the difference, and calculates the proportion of significant tests.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy <span style="color: #4f97d7; font-weight: bold;">import</span> stats

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to simulate data and perform a t.test</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">sim_ttest</span>(mu1, mu2, sd, n1, n2):
    <span style="color: #7590db;">x</span> = stats.norm.rvs(loc = mu1, scale = sd, size = n1)
    <span style="color: #7590db;">y</span> = stats.norm.rvs(loc = mu2, scale = sd, size = n2)
    <span style="color: #4f97d7; font-weight: bold;">return</span>(stats.ttest_ind(x, y)[<span style="color: #a45bad;">1</span>])

<span style="color: #2aa1ae; background-color: #292e34;">##  </span><span style="color: #2aa1ae; background-color: #292e34;">run the function 10,000 times</span>
<span style="color: #7590db;">nsims</span> = <span style="color: #a45bad;">10000</span>
<span style="color: #7590db;">p</span> = [sim_ttest(<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">50</span>, <span style="color: #a45bad;">150</span>)  <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span>(nsims)]
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">calculate proportion of significant tests</span>
<span style="color: #4f97d7; font-weight: bold;">print</span>(<span style="color: #4f97d7;">len</span>([x <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> p <span style="color: #4f97d7; font-weight: bold;">if</span> x &lt; .<span style="color: #a45bad;">05</span>])/nsims)
</pre>
</div>

<pre class="example">
....:    ....:    ....:    ....:




0.4468
</pre>
</div></li>

<li><a id="orgheadline39"></a>Submit file<br  /><div class="outline-text-5" id="text-orgheadline39">
<p>
If we want to run this function one million times it may take a while, especially if our computer is an older less powerful model. So let's run it on 100 separate machines (each one will simulate the test 10000 times). To do that we need, in addition to the python script above, a submit file to request resources and run the computation.  
</p>
<div class="org-src-container">

<pre class="src src-conf"><span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
<span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
<span style="color: #7590db;">Universe</span> = vanilla

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the python program.</span>
<span style="color: #7590db;">Executable</span> = /usr/local/bin/python33

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Here we pass arguments to make python not save or restore workspaces,</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">and to run as quietly as possible.</span>
<span style="color: #7590db;">Arguments</span> = power.py

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Note that unlike R batch job submission we pass the python script in</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">the Arguments section rather than in the "Input" section.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify the relative path to the input file</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to output any results printed by your program.</span>
<span style="color: #7590db;">output</span> = output/out.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
<span style="color: #7590db;">error</span> = output/error.$(Process)
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save the log file.</span>
<span style="color: #7590db;">Log</span> = output/log

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request.</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">This section should always come last.</span>
Queue 100
</pre>
</div>

<p>
Now that we have our script and the submit file we can run submit the job as follows:
</p>
<ol class="org-ol">
<li>make a project folder for this run if it doesn't exist</li>
<li>save the python script (as power.python) and the submit file (as power.submit) in the project folder</li>
<li>make a sub folder named <code>output</code></li>
<li>open a terminal and <code>cd</code> to the project folder</li>
<li>run <code>condor_submit power.submit</code> to submit the jobs to the cluster</li>
</ol>
</div></li>

<li><a id="orgheadline40"></a>Aggregating results<br  /><div class="outline-text-5" id="text-orgheadline40">
<p>
When your batch job is finished you are usually left with multiple output files that need to be aggregated. In the case of our simulation example, we have files <code>output/out.0 -- output/out99</code>, each of which contains a single number representing the proportion of significant tests. We can aggregate them with a simple python script, like this:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> glob
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">list all output files in the output directory</span>
<span style="color: #7590db;">output_files</span> = glob.glob(<span style="color: #2d9574;">"output/out*"</span>)

<span style="color: #7590db;">output_values</span> = <span style="color: #4f97d7;">map</span>(<span style="color: #4f97d7; font-weight: bold;">lambda</span> f: np.<span style="color: #4f97d7;">float</span>(<span style="color: #4f97d7;">open</span>(f).read()), output_files)
<span style="color: #4f97d7; font-weight: bold;">print</span>(<span style="color: #4f97d7;">list</span>(output_values))
</pre>
</div>
</div></li>

<li><a id="orgheadline41"></a>Try it yourself!<br  /><div class="outline-text-5" id="text-orgheadline41">
<p>
Download the <a href="Python_examples/power1.zip">power simulation example files</a>, to the pythonCE, extract the zip file and running <code>condor_submit power.submit</code> in the <code>power1</code> directory.
</p>
</div></li></ul>
</div>

<div id="outline-container-orgheadline42" class="outline-4">
<h4 id="orgheadline42">Batch example: Power simulation in python with varying parameters</h4>
<div class="outline-text-4" id="text-orgheadline42">
<p>
The previous example was relatively simple, because we wanted to run exactly the same code on all 100 nodes. Often however you want each node to do something slightly different. For example, we may wish to vary the sample size from 100 &#x2013; 500 in increments of 10, to see how power changes as a function of that parameter. In that case we need to pass some additional information to each process, telling it which parameter space it is responsible for. 
</p>

<p>
As it turns out, we almost already know how to do that: if you you look closely at the submit file in the previous example you will notice that we used <code>$(Process)</code> to append the process number to the output and error files. 
</p>
</div>
<ul class="org-ul"><li><a id="orgheadline43"></a>Submit file passing process as an argument<br  /><div class="outline-text-5" id="text-orgheadline43">
<p>
We can use the <code>$(Process)</code> macro to pass information to our program, like this:
</p>
<div class="org-src-container">

<pre class="src src-conf">  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Universe whould always be 'vanilla'. This line MUST be </span>
  <span style="color: #2aa1ae; background-color: #292e34;">#</span><span style="color: #2aa1ae; background-color: #292e34;">included in your submit file, exactly as shown below.</span>
  <span style="color: #7590db;">Universe</span> = vanilla

  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the path to the python program.</span>
  <span style="color: #7590db;">Executable</span> = /usr/local/bin/python33

  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify any arguments you want to pass to the executable</span>
  <span style="color: #7590db;">Arguments</span> = power.py $(Process)

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to output any results printed by your program.</span>
  <span style="color: #7590db;">output</span> = output/out.$(Process)

  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Specify where to save any errors returned by your program.</span>
  <span style="color: #7590db;">error</span> = output/error.$(Process)

  <span style="color: #7590db;">Log</span> = log.txt
  <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Enter the number of processes to request.</span>
  Queue 40
</pre>
</div>

<p>
Notice that we used <code>--args $(Process)</code> to pass the process number to the python program. <code>$(Process)</code> will be an integer starting from <code>0</code>. 
</p>
</div></li>

<li><a id="orgheadline44"></a>python script argument processing<br  /><div class="outline-text-5" id="text-orgheadline44">
<p>
Next we need to 1) retrieve the process number in our python program and 2) map it to the parameter space. We can retrieve the arguments in python like this:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> sys
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">retrieve arguments passed from the command line.</span>
<span style="color: #7590db;">process</span> = <span style="color: #4f97d7;">int</span>(sys.argv[<span style="color: #a45bad;">1</span>])
</pre>
</div>
<p>
We now have a variable in python that tells us which process we are. Now we need to map that to our parameter space; recall that we want to test sample sizes from 100 to 500, so we need to map <code>process 0</code> to <code>n = 100</code>,  <code>process 1</code> to <code>n = 110</code>, <code>process 2</code> to <code>n = 120</code> and so on:
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">map process to sample size parameter.</span>
<span style="color: #7590db;">n</span> = (process + <span style="color: #a45bad;">100</span>) + (process*<span style="color: #a45bad;">10</span> - process)
</pre>
</div>

<p>
There is one additional complication we need to handle: in the previous example we did need to keep track of the parameters used by each process because the parameters did not vary. Now that they do, it would be nice if we had output that recorded the value of the varying parameter as well as the result. We could of course just print the <code>n</code> parameter we calculated from the process number along with the result, but it will be easier to combine the outputs if we write them to a machine-readable format (e.g., a comma-separated-values file). You may have noticed that in the submit file above I omitted the <code>output</code> directive: that is because we are going to explicitly save the results in the python script, so we don't need the batch scheduler to save those output files for us.
</p>

<p>
Now we can set up the simulation as before, passing the <code>n</code> calculated above into our simulation function, writing the results to files. 
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to simulate data and perform a t.test</span>
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">from</span> scipy <span style="color: #4f97d7; font-weight: bold;">import</span> stats

<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">function to simulate data and perform a t.test</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">sim_ttest</span>(mu1, mu2, sd, n1, n2):
    <span style="color: #7590db;">x</span> = stats.norm.rvs(loc = mu1, scale = sd, size = n1)
    <span style="color: #7590db;">y</span> = stats.norm.rvs(loc = mu2, scale = sd, size = n2)
    <span style="color: #4f97d7; font-weight: bold;">return</span>(stats.ttest_ind(x, y)[<span style="color: #a45bad;">1</span>])

<span style="color: #2aa1ae; background-color: #292e34;">##  </span><span style="color: #2aa1ae; background-color: #292e34;">run the function 10,000 times</span>
<span style="color: #7590db;">nsims</span> = <span style="color: #a45bad;">10000</span>
<span style="color: #7590db;">p</span> = [sim_ttest(<span style="color: #a45bad;">1</span>, <span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">3</span>, <span style="color: #a45bad;">1</span>, n, n)  <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> <span style="color: #4f97d7;">range</span>(nsims)]
<span style="color: #4f97d7; font-weight: bold;">print</span>(<span style="color: #4f97d7;">len</span>([x <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> p <span style="color: #4f97d7; font-weight: bold;">if</span> x &lt; .<span style="color: #a45bad;">05</span>])/nsims)
<span style="color: #4f97d7; font-weight: bold;">print</span>(n)
</pre>
</div>

<p>
Now we have all the required elements to submit out job, and can do so using <code>condor_submit</code> as before. 
</p>
</div></li>

<li><a id="orgheadline45"></a>Aggregating results<br  /><div class="outline-text-5" id="text-orgheadline45">
<p>
Each of our 40 processes produced a file in the <code>output</code> directory name <code>out&lt;process&gt;csv</code>; our next task is to aggregate these results. The python script below reads each of these files, joins them together into a single array, and plots the result.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> glob
<span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
<span style="color: #2aa1ae; background-color: #292e34;">## </span><span style="color: #2aa1ae; background-color: #292e34;">list all output files in the output directory</span>
<span style="color: #7590db;">output_files</span> = glob.glob(<span style="color: #2d9574;">"output/out*"</span>)

<span style="color: #7590db;">output_values</span> = np.array([x.split(<span style="color: #2d9574;">"\n"</span>)[:<span style="color: #a45bad;">2</span>]
                          <span style="color: #4f97d7; font-weight: bold;">for</span> x <span style="color: #4f97d7; font-weight: bold;">in</span> [<span style="color: #4f97d7;">open</span>(f).read() <span style="color: #4f97d7; font-weight: bold;">for</span> f <span style="color: #4f97d7; font-weight: bold;">in</span> output_files]],
                         dtype = <span style="color: #2d9574;">"float"</span>)

plt.plot(<span style="color: #4f97d7;">list</span>(output_values[:, <span style="color: #a45bad;">1</span>]), <span style="color: #4f97d7;">list</span>(output_values[:, <span style="color: #a45bad;">0</span>]), <span style="color: #2d9574;">"bo"</span>)
plt.xlabel(<span style="color: #2d9574;">"Sample Size"</span>)
plt.ylabel(<span style="color: #2d9574;">"Power"</span>)
plt.savefig(<span style="color: #2d9574;">"power.png"</span>)
</pre>
</div>


<div class="figure">
<p><img src="images/python_powerDist.png" alt="python_powerDist.png" />
</p>
</div>
</div></li>

<li><a id="orgheadline46"></a>Try it yourself!<br  /><div class="outline-text-5" id="text-orgheadline46">
<p>
Download the <a href="Python_examples/power2.zip">power simulation example files</a>, to the pythonCE, extract the zip file, and run the example by calling <code>condor_submit power.submit</code> from the <code>power2</code> directory.
</p>
</div></li></ul>
</div>
</div>
</div>




<div id="outline-container-orgheadline47" class="outline-2">
<h2 id="orgheadline47">Monitoring and manageing submitted batch jobs</h2>
<div class="outline-text-2" id="text-orgheadline47">
<p>
After submitting the jobs we may wish to monitor them, e.g. to check if they are running. You can do this by running <code>condor_q &lt;your_user_name&gt;</code> in a terminal. If this returns nothing then you have no jobs in the queue. Otherwise you will see information for each request in the queue which will look something like this:
</p>
<pre class="example">
-- Schedd: HMDC.batch@rce6-5.hmdc.harvard.edu : &lt;10.0.0.10:9619?sock=7858_e19e_247&gt;
 ID      OWNER            SUBMITTED     RUN_TIME ST PRI SIZE CMD               
 200.0   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.1   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.2   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.3   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.4   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.5   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.6   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.7   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.8   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.9   izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.10  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.11  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
 200.12  izahn           4/27 11:45   0+00:00:04 R  0   0.0  R --no-save --no-r
</pre>
<p>
Perhaps the most important information returned by <code>condor_q</code> is the program status (the <b>ST</b> column). Status <b>I</b> means your job is in the queue but has not yet started running, <b>R</b> means the job is currently running, and <b>H</b> means the job is on hold. If you job is on hold you can get more information about what the problem might be by running <code>condor_q -hold</code>.
</p>

<p>
You will know your job is finished when it is no longer listed in the <code>condor_q</code> output. When it finishes you can examine the output and/or error files to see if the program exited successfully.
</p>

<p>
If you would like to remove a batch job from the queue you may do so using <code>condor_rm</code>. For example <code>condor_rm 200</code> will remove the jobs listed above.
</p>

<p>
For more details on monitoring and manageing your batch jobs please refer to <a href="http://projects.iq.harvard.edu/rce/book/checking-your-process-status">http://projects.iq.harvard.edu/rce/book/checking-your-process-status</a>
</p>
</div>

<div id="outline-container-orgheadline21" class="outline-4">
<h4 id="orgheadline21"><span class="todo TODO">TODO</span> Matlab Batch Examples</h4>
</div>
</div>


<div id="outline-container-orgheadline51" class="outline-2">
<h2 id="orgheadline51"><span class="todo TODO">TODO</span> Installing custom packages on the RCE</h2>
<div class="outline-text-2" id="text-orgheadline51">
</div><div id="outline-container-orgheadline48" class="outline-3">
<h3 id="orgheadline48">Installing R packages</h3>
</div>

<div id="outline-container-orgheadline49" class="outline-3">
<h3 id="orgheadline49">Installing Python packages</h3>
</div>

<div id="outline-container-orgheadline50" class="outline-3">
<h3 id="orgheadline50">Installing Stata packages</h3>
</div>
</div>

<div id="outline-container-orgheadline52" class="outline-2">
<h2 id="orgheadline52"><span class="todo TODO">TODO</span> Getting help</h2>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
Note: The Windows zipfile contains the NX client, plus optional font packages. HMDC recommends installing all font packages, though this is not required.
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
We use R for this example because it is the most commonly used program by RCE users. If you use Stata, Matlab, or something else, don't worry, we will have examples for you!
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p><span xmlns:dct='http://purl.org/dc/terms/' property='dct:title'> These workshop notes </span> by <a xmlns:cc='http://creativecommons.org/ns#' href='http://dss.iq.harvard.edu' property='cc:attributionName' rel='cc:attributionURL'>Harvard University</a> are licensed <a rel='license' href='http://creativecommons.org/licenses/by-sa/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by-sa/4.0/80x15.png' /></a>. Presented by <a href='http://dss.iq.harvard.edu'>Data Science Services</a> at <a href='http://iq.harvard.edu'> IQSS</a></p>
</div>
</body>
</html>
